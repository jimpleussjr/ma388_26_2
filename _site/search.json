[
  {
    "objectID": "lessons/lsn_9_runs_expectancy_matrix.html",
    "href": "lessons/lsn_9_runs_expectancy_matrix.html",
    "title": "MA388 Sabermetrics: Lesson 9",
    "section": "",
    "text": "library(tidyverse)\nlibrary(Lahman)\nlibrary(knitr)\nlibrary(ggrepel)\nlibrary(broom)"
  },
  {
    "objectID": "lessons/lsn_9_runs_expectancy_matrix.html#review",
    "href": "lessons/lsn_9_runs_expectancy_matrix.html#review",
    "title": "MA388 Sabermetrics: Lesson 9",
    "section": "Review",
    "text": "Review\nLast lesson, we discussed the following three models:\n\\[\\begin{align}\nWpct &= \\beta_0 + \\beta_1 RD + \\epsilon \\\\\nWpct &= \\frac{R^2}{R^2 + RA^2} + \\epsilon \\\\\nWpct &= \\frac{R^k}{R^k + RA^k} + \\epsilon\n\\end{align}\\]\n\nDetermine the value of \\(k\\) in the third model for the 2018 season.\nCalculate the predicted wins for each team in 2018 and plot the residuals vs. the predicted values.\n\n\n\n\n\n\nPythagorean predictions (2018)"
  },
  {
    "objectID": "lessons/lsn_9_runs_expectancy_matrix.html#value-of-plays",
    "href": "lessons/lsn_9_runs_expectancy_matrix.html#value-of-plays",
    "title": "MA388 Sabermetrics: Lesson 9",
    "section": "Value of Plays",
    "text": "Value of Plays\nUsing the 10-runs-per-win rule of thumb (or more precise estimates using the other models), we now have a nice way of converting runs to wins. This leads to our next obvious question – how do we score runs? Simply put, players make plays, and sometimes those plays lead to runs. It’s time to assess how many runs players and plays are worth.\n\nRun Expectancy Matrix\n* The first step is to calculate the run expectancy matrix. The run expectancy matrix tells us the average number of runs scored in the remainder of an inning for each state (runner/out combination) of an inning.\nThe state of the game consists of four digits. The first three digits indicate the location of runners on base. The last digit indicates the number of outs.\nExamples:\n\n“000 0” - no runners on base; no outs\n“111 2” - bases loaded; two outs\n“010 1” - runner on second base; one out\n\n\n\n\nRun Expectancy Matrices (source: http://tangotiger.net/re24.html)\n\n\nHow do we interpret the values in the matrix?\n\n\n\n\n\nDo you see any trends over time?\n\n\n\n\n\nWe are looking at run expectancy matrices. There is another type of matrix called a run probability matrix. Explain how they differ.\n\n\n\n\n\n\n\nRun Expectancy Matrix from Retrosheet Data\nTypically, we use Retrosheet play-by-play data to calculate the run expectancy matrix. Below, we will calculate it for 2011 using the code from our textbook.\n\n# Import Retrosheet play-by-play data from our textbook site.\n\nsite = \"https://raw.githubusercontent.com/maxtoki/baseball_R/\"\nfields &lt;- read_csv(file = paste(site, \"master/data/fields.csv\", sep =\"\"))\nretro2011 &lt;- read_csv(file = paste(site, \"master/data/all2011.csv\", sep = \"\"),\n                    col_names = pull(fields, Header),\n                    na = character())\ncolnames(retro2011) &lt;- tolower(colnames(retro2011))\n\nThis data frame contains one line for every play in the 2011 season. There are approximately 200,000 lines in this data set.\n\nretro2011 |&gt; \n  select(game_id, away_team_id, inn_ct, outs_ct,\n         bat_id, pit_id, event_cd) |&gt; \n  head(10) |&gt; \n  kable()\n\n\n\n\n\n\n\n\n\n\n\n\n\ngame_id\naway_team_id\ninn_ct\nouts_ct\nbat_id\npit_id\nevent_cd\n\n\n\n\nANA201104080\nTOR\n1\n0\ndavir003\nsante001\n2\n\n\nANA201104080\nTOR\n1\n1\nnix-j001\nsante001\n2\n\n\nANA201104080\nTOR\n1\n2\nbautj002\nsante001\n3\n\n\nANA201104080\nTOR\n1\n0\niztum001\ndrabk001\n14\n\n\nANA201104080\nTOR\n1\n0\nkendh001\ndrabk001\n3\n\n\nANA201104080\nTOR\n1\n1\nabreb001\ndrabk001\n6\n\n\nANA201104080\nTOR\n1\n2\nabreb001\ndrabk001\n14\n\n\nANA201104080\nTOR\n1\n2\nhuntt001\ndrabk001\n20\n\n\nANA201104080\nTOR\n1\n2\nwellv001\ndrabk001\n2\n\n\nANA201104080\nTOR\n2\n0\nlinda001\nsante001\n2\n\n\n\n\n\nTo understand what happened in this game, we’ll need to know what all the event codes are for various baseball outcomes described by the event_cd field.\n\n\n\nEvent codes\n\n\nIf we further consider the event_tx and pitch_seq_tx fields, we can more comprehensively reconstruct each at-bat. Let’s try to describe what happened in the first inning of this game. We’ll need to know the position numbers to interpret the event text strings.\n\n\n\nBaseball Position Numbers\n\n\n\n\nretro2011 |&gt; \n  select(inn_ct, outs_ct,\n         bat_id, pit_id, pitch_seq_tx, event_tx) |&gt; \n  head(10) |&gt; \n  kable()\n\n\n\n\n\n\n\n\n\n\n\n\ninn_ct\nouts_ct\nbat_id\npit_id\npitch_seq_tx\nevent_tx\n\n\n\n\n1\n0\ndavir003\nsante001\nFBSX\n9/F\n\n\n1\n1\nnix-j001\nsante001\nX\n9/F\n\n\n1\n2\nbautj002\nsante001\nCBCS\nK\n\n\n1\n0\niztum001\ndrabk001\nCBBBB\nW\n\n\n1\n0\nkendh001\ndrabk001\nBCSBS\nK\n\n\n1\n1\nabreb001\ndrabk001\nCBB1&gt;S\nCS2(26)\n\n\n1\n2\nabreb001\ndrabk001\nCBB1&gt;S.FBFB\nW\n\n\n1\n2\nhuntt001\ndrabk001\nCCX\nS9/L.1-H(E9/TH)(UR)(NR);B-3\n\n\n1\n2\nwellv001\ndrabk001\nBX\n63/G\n\n\n2\n0\nlinda001\nsante001\nCBBFX\n3/L-\n\n\n\n\n\n\n\n\nCalculate the Run Expectancy Matrix\nThe textbook provides the code below to generate the run expectancy matrix.\n\nretro2011 &lt;- retro2011 |&gt; \n  mutate(runs_before = away_score_ct + home_score_ct,\n         half_inning = paste(game_id, inn_ct, bat_home_id),\n         runs_scored = \n           (bat_dest_id &gt; 3) + (run1_dest_id &gt; 3) + \n           (run2_dest_id &gt; 3) + (run3_dest_id &gt; 3))\n\nhalf_innings &lt;- retro2011 |&gt;\n  group_by(half_inning) |&gt;\n  summarize(outs_inning = sum(event_outs_ct),\n            runs_inning = sum(runs_scored),\n            runs_start = first(runs_before),\n            max_runs = runs_inning + runs_start)\n\nretro2011 &lt;- retro2011 |&gt;\n  inner_join(half_innings, by = \"half_inning\") |&gt;\n  mutate(runs_roi = max_runs - runs_before)\n\nretro2011 &lt;- retro2011 |&gt;\n  mutate(bases = \n           paste(ifelse(base1_run_id &gt; '',1,0),\n                 ifelse(base2_run_id &gt; '',1,0),\n                 ifelse(base3_run_id &gt; '',1,0), sep = \"\"),\n         state = paste(bases, outs_ct))\n\nretro2011 &lt;- retro2011 |&gt;\n  mutate(is_runner1 =\n           as.numeric(run1_dest_id==1 | bat_dest_id == 1),\n         is_runner2 = \n           as.numeric(run1_dest_id == 2 | run2_dest_id == 2 |\n                        bat_dest_id == 2),\n         is_runner3 = \n           as.numeric(run1_dest_id == 3 | run2_dest_id == 3 |\n                        run3_dest_id == 3 | bat_dest_id == 3),\n         new_outs = outs_ct + event_outs_ct,\n         new_bases = paste(is_runner1,is_runner2, is_runner3, sep = \"\"),\n         new_state = paste(new_bases, new_outs))\n\n\n\nretro2011 &lt;- retro2011 |&gt;\n  filter((state != new_state) | (runs_scored &gt; 0))\n\nretro2011_complete &lt;- retro2011 |&gt;\n  filter(outs_inning == 3)\n\nerm_2011 &lt;- retro2011_complete |&gt;\n  group_by(bases, outs_ct) |&gt; # same as grouping by state\n  summarize(mean_run_value = mean(runs_roi))\n\nerm_2011_wide &lt;- erm_2011 |&gt; \n  pivot_wider(\n    names_from = outs_ct, \n    values_from = mean_run_value, \n    names_prefix = \"Outs=\"\n  )\n\nwrite_csv(erm_2011_wide, \"erm_2011_wide.csv\")\n\nerm_2011_wide |&gt; kable()\n\n\n\n\nbases\nOuts=0\nOuts=1\nOuts=2\n\n\n\n\n000\n0.4711649\n0.2546956\n0.0971845\n\n\n001\n1.4543568\n0.9374359\n0.3173913\n\n\n010\n1.0582804\n0.6501976\n0.3091673\n\n\n011\n1.9304897\n1.3388641\n0.5407407\n\n\n100\n0.8350992\n0.4960492\n0.2179536\n\n\n101\n1.7526998\n1.1496169\n0.4882597\n\n\n110\n1.4144549\n0.8739176\n0.4222569\n\n\n111\n2.1718266\n1.4745146\n0.7610094\n\n\n\n\n\nNow we use this expected run table to determine the value of every event.\n\nretro2011 &lt;- retro2011 |&gt; \n  left_join(erm_2011, join_by(\"bases\", \"outs_ct\")) |&gt; \n  rename(rv_start = mean_run_value) |&gt; \n  left_join(\n    erm_2011, \n    join_by(new_bases == bases, new_outs == outs_ct)\n  ) |&gt; \n  rename(rv_end = mean_run_value) |&gt; \n  replace_na(list(rv_end = 0)) |&gt; \n  mutate(run_value = rv_end - rv_start + runs_scored)\n\nNote the code above also adds some very useful columns to the play-by-play data related to the state and run expectancy at the start and end of each play.\n\nretro2011 |&gt; \n select(bat_id, event_cd, state, rv_start,\n        new_state, rv_end, runs_scored, run_value) |&gt;\n  head(10) |&gt; \n  kable(digits = 3)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nbat_id\nevent_cd\nstate\nrv_start\nnew_state\nrv_end\nruns_scored\nrun_value\n\n\n\n\ndavir003\n2\n000 0\n0.471\n000 1\n0.255\n0\n-0.216\n\n\nnix-j001\n2\n000 1\n0.255\n000 2\n0.097\n0\n-0.158\n\n\nbautj002\n3\n000 2\n0.097\n000 3\n0.000\n0\n-0.097\n\n\niztum001\n14\n000 0\n0.471\n100 0\n0.835\n0\n0.364\n\n\nkendh001\n3\n100 0\n0.835\n100 1\n0.496\n0\n-0.339\n\n\nabreb001\n6\n100 1\n0.496\n000 2\n0.097\n0\n-0.399\n\n\nabreb001\n14\n000 2\n0.097\n100 2\n0.218\n0\n0.121\n\n\nhuntt001\n20\n100 2\n0.218\n001 2\n0.317\n1\n1.099\n\n\nwellv001\n2\n001 2\n0.317\n001 3\n0.000\n0\n-0.317\n\n\nlinda001\n2\n000 0\n0.471\n000 1\n0.255\n0\n-0.216\n\n\n\n\n\n\nlibrary(baseballr) #the appendix does not tell you that you need this. \n\nretro_data&lt;-retrosheet_data(years=2022)\nretro2022 &lt;- retro_data |&gt;\npluck(\"2022\") |&gt;\npluck(\"events\")\nroster2022 &lt;- retro_data |&gt;\npluck(\"2022\") |&gt;\npluck(\"rosters\")\nroster2022_clean&lt;-roster2022 |&gt;\nselect(player_id,last_name,first_name) |&gt;\nrename(bat_id=player_id) |&gt; \n  distinct()\n\nstats&lt;-retro2022 |&gt; #I split the code chunk so I don't have to do the slow step every time I run it\nselect(bat_id,event_cd,bat_home_id) |&gt; #grab only the columns I want\nfilter(event_cd&gt;=20|event_cd==2|event_cd==3) |&gt; #events &gt;= 20 are hits, 2+3 are out/strikeout\ngroup_by(bat_id,bat_home_id) |&gt;\nmutate(\nhit=if_else(event_cd&gt;=20,1,0), #if play event was hit make it 1 if not 0\nab=1, #all of these are ABs, making them 1 to sum later\nhome_away=if_else(bat_home_id==1,\"Home\",\"Away\"))\n\nplayer_stats&lt;-stats |&gt;\ngroup_by(bat_id,home_away) |&gt;\nsummarize(AB=sum(ab),H=sum(hit),AVG=H/AB) |&gt;\nfilter(AB&gt;=100) #filter out players with &lt;100 ABs\n\nplayer_home_v_away&lt;-player_stats |&gt;\nselect(bat_id,home_away,AVG) |&gt;\npivot_wider(id_cols = bat_id,\nnames_from = home_away,\nvalues_from=AVG,\n)\n\nroster2022 |&gt; count(player_id) |&gt; arrange(-n)\n\n# A tibble: 1,495 × 2\n   player_id     n\n   &lt;chr&gt;     &lt;int&gt;\n 1 chany001      4\n 2 fordm002      4\n 3 abrea001      3\n 4 banda001      3\n 5 canor001      3\n 6 chavj001      3\n 7 duggs001      3\n 8 fairs001      3\n 9 gonzc002      3\n10 keucd001      3\n# ℹ 1,485 more rows\n\nplayer_home_v_away&lt;-player_home_v_away |&gt;\nleft_join(roster2022_clean,by=\"bat_id\")\nplayer_home_v_away |&gt;\nmutate(Difference=abs(Home-Away)) |&gt;\narrange(Difference) |&gt;\nhead(10) |&gt;\nselect(last_name,first_name,Difference)\n\n# A tibble: 10 × 4\n# Groups:   bat_id [10]\n   bat_id   last_name  first_name Difference\n   &lt;chr&gt;    &lt;chr&gt;      &lt;chr&gt;           &lt;dbl&gt;\n 1 darnt001 d'Arnaud   Travis       0       \n 2 vierm001 Vierling   Matt         0.000149\n 3 andre001 Andrus     Elvis        0.000569\n 4 wendj002 Wendle     Joey         0.000605\n 5 santc002 Santana    Carlos       0.00110 \n 6 merrw001 Merrifield Whit         0.00151 \n 7 heimj001 Heim       Jonah        0.00156 \n 8 smitp002 Smith      Pavin        0.00192 \n 9 estrt001 Estrada    Thairo       0.00196 \n10 rizza001 Rizzo      Anthony      0.00208"
  }
]