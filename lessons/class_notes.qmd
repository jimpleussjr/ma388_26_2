---
title: "Class Code"
format: pdf
editor: visual
---

```{r}
library(Lahman)
library(tidyverse)
library(knitr)
library(broom)
```

## Create top 10 Yankee career batting average

```{r}
Yankees <- 
  Batting |> 
  filter(teamID == 'NYA') |> 
  summarize(hits = sum(H),at_bats=sum(AB),.by='playerID') |> 
  mutate(BA = hits/at_bats) |> 
  filter(at_bats>=2500) |> 
  arrange(-BA) |>
  head(10)
```

```{r}
Yankees |> 
  left_join(select(People, playerID, nameLast, nameFirst, finalGame), by = "playerID" ) |> 
  left_join(select(HallOfFame, playerID, inducted, yearID)|> 
              filter(inducted!="N")
            , by = "playerID") |> 
  select(-playerID) |> 
  relocate(nameLast,nameFirst) |> 
  arrange(inducted,finalGame) |> 
  kable()



```

```{r}
Teams |> 
  filter(yearID >1999) |> 
  select(teamID,W,G,WSWin) |> 
  # mutate(WSWin = ifelse(WSWin=='Y',1,0)) |>
  group_by(teamID) |> 
  summarize(W=sum(W),G=sum(G),WSWins= sum(WSWin=="Y")) |> 
  mutate(Wpct=W/G) |> 
  arrange(-Wpct)

names(Teams)
```

```{r}
# Step 1 - Write a function.
mostWins <- function(data){
  data |> 
    arrange(-W) |> 
    select(teamID, W, WSWin) |> 
    head(1)
}

# Step 2 - Pull the years you will split on.
year <- Teams |> 
  filter(yearID >= 2000) |> 
  group_by(yearID) |> 
  group_keys() |> 
  pull(yearID)

# Steps 3 and 4 - Split and apply.
winLeaders <- Teams |> 
  filter(yearID >= 2000) |> 
  split(year) |>
  map_df(mostWins, .id = "yearID")

winLeaders |> 
  kable(caption = "Major League win leaders by season and whether they won the World Series.")
```

### Pulling in the various data frames

```{r}
library(baseballr)

Batting |> 
  filter(between(yearID, 2010,2025)) |> 
  left_join(People |> select(playerID,nameLast,nameFirst,bats)) |> 
  summarize(H=sum(H),AB=sum(AB),.by=c('yearID','bats')) |> 
  mutate(AVG = H/AB) |> 
  pivot_wider(id_cols='yearID',names_from = 'bats',values_from ='AVG')
```

### Lesson 4 In-Class

```{r}
hr_df <-
  Batting |> 
  mutate(HRcareer = cumsum(HR),.by='playerID')


hr_leader <- 
  function(data, year){
    data |> 
      select(yearID,playerID,HRcareer) |> 
      filter(yearID<=year) |> 
      slice_max(HRcareer) |> 
      # arrange(-HRcareer) |> 
      # head(1) |> 
      mutate(year=year) |> 
      relocate(year)
  }


home_runs<- 
map_df(.x=1900:2025, .f = ~hr_leader(data=hr_df,year=.x)) |> 
  left_join(People |> select(playerID,nameLast,nameFirst),by='playerID')
```

### GGplot

```{r}
home_runs |> 
  ggplot(aes(x=year,y=HRcareer,color=nameLast))+
  geom_line(linewidth=2)+
  labs(x='Year',
       y='Home Run Leader',
       color='Player',
       title='Career Homerun Leader by Year')
```

### Lesson 5

```{r}

batting_df <- 
  Batting |> 
  slice_max(HR,n=10,by=yearID) |> 
  arrange(yearID) |> 
  mutate(era = cut(yearID,
                   breaks = c(1899, 1919, 1941, 1960, 1976, 
                              1993, 2003, 2050),
                   labels = c("Dead Ball", "Lively Ball", "Integration",
                              "Expansion", "Free Agency", "Steroid",
                              "Long Ball")
  )
  )
```

```{r}
batting_df |> 
  # filter(yearID>1899) |> 
  filter(!is.na(era)) |> 
  ggplot(aes(x=yearID, y=HR, color=era)) +
  geom_point()+
  geom_smooth()+
  theme_classic()
```

```{r}
Salaries %>% 
  mutate(decade = floor(yearID / 10) * 10) %>% 
  head()
```

```{r}
Salaries %>% 
  mutate(decade = floor(yearID / 10) * 10) %>% 
  # ggplot(aes(x =decade, y = salary)) + 
  ggplot(aes(x = as.factor(decade), y = salary)) +
  geom_boxplot() + 
  scale_y_continuous(labels = scales::comma) +
  labs(title = "MLB Salaries by Decade",
       y = "Salary",
       x = "Decade") + 
  coord_flip()
```

```{r}
# Get career wins, earned run average, and strikeouts.
careers <- Pitching %>% 
  group_by(playerID) %>% 
  summarize(W = sum(W),
            ER = sum(ER),
            IPouts = sum(IPouts),
            SO = sum(SO)) %>% 
  mutate(ERA = 9*ER/(IPouts/3)) %>% 
  filter(IPouts/3 > 500)

# Add whether they were inducted in the Hall of Fame.
careers <- HallOfFame %>% 
  filter(inducted == "Y",
         category == "Player") %>% 
  select(playerID, inducted) %>% 
  right_join(careers) %>% 
  mutate(inducted = replace_na(inducted,"N"))

careers %>% 
  ggplot(aes(x = SO, y = ERA, color = inducted)) +
  geom_point(size = 1)

clemschil <- careers %>% 
  filter(playerID %in% c("clemero02", "schilcu01")) 


```

```{r}
library(ggrepel)
clemschil <- careers %>% 
  filter(playerID %in% c("clemero02", "schilcu01")) 

careers %>% 
  ggplot(aes(x = SO, y = ERA, color = inducted)) +
  geom_point() +
  geom_text_repel(data = clemschil, 
                  aes(x = SO, y = ERA, label = playerID),
                  show.legend = FALSE)
```

```{r}
library(ggrepel)
clemschil <- careers %>% 
  filter(playerID %in% c("clemero02", "schilcu01")) 

careers %>% 
  ggplot(aes(x = SO, y = ERA, color = inducted)) +
  geom_point() +
  geom_text_repel(data = clemschil, 
                  aes(x = SO, y = ERA, label = playerID),
                  show.legend = FALSE)
```
### Lesson 8

#### AY26-2 Notes

Went through the way we get to *k* from the pythagoreon model on the board which was good.

Also did the partial derivative with respect to Runs to find the incremental number of wins per net runs scored. 

Ran out of time a little at the end to get to the incremental runs model.




### Lesson 9

#### AY26-2 Notes

Went well. Good to emphasize the retrosheet and statcast at the end.

```{r}
library(Lahman)

teams2018 <- Teams |> 
  filter(yearID == 2018) |> 
  mutate(Wpct = W/(W+L),
         logWL = log(W/L),
         logRRA = log(R/RA))

k <- teams2018 |> 
  lm(logWL ~ 0 + logRRA, data = _) |> 
  tidy() |> 
  pull(estimate)

teams2018 |> 
  mutate(pred_Wpct = R^k/(R^k+RA^k),
         residual = Wpct - pred_Wpct) |> 
  ggplot(aes(x=pred_Wpct,y=residual,label=teamID)) +
  geom_point()+
  geom_text_repel()+
  labs(x="Predicted Win Percentage",y='Residuals')
  

```

```{r}
library(baseballr)

baseballr::retrosheet_data(years_to_acquire = 2018) |> 
  pluck('events') 
```
### Lesson 10

#### AY26-2 Notes

Make sure the RunExpectancyMatrix.R is in the files for cadets to download. 

Making them re-run the data from last class was a little clunky.

Didn't have enough time to really dive into the run value by `hit_type` much. Need more on the motivation of each.

Should explain how those values aren't perfectly linear and aren't direct multiples of each other like slugging percentage. 

### Lesson 11


